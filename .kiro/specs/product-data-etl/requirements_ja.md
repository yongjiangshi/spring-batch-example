# 要件定義書

## 概要

この機能は、高度なバッチ処理機能を実証するマルチステップのSpring Batch ETLパイプラインを実装します。システムは最初にCSVファイルから製品データをデータベースにインポートし、次にそのデータを処理およびフィルタリングして、新しいCSVファイルとして売上レポートを生成します。これは、単一のジョブ内でファイルからデータベース、データベースからファイルへの操作を示すSpring Batchの包括的な学習例です。

## 要件

### 要件 1

**ユーザーストーリー：** Spring Batchを学習するソフトウェア開発者として、適切なバッチ処理依存関係を持つSpring Bootプロジェクトを設定し、複雑なマルチステップバッチジョブを構築できるようにしたい。

#### 受け入れ基準

1. プロジェクトが作成されたとき、システムはspring-boot-starter-batch、spring-boot-starter-data-jpa、h2database依存関係を含むものとする
2. アプリケーションが開始されたとき、システムはテストと開発を容易にするためにH2インメモリデータベースを使用するものとする
3. アプリケーションが初期化されたとき、システムはschema.sqlを使用してid、name、description、priceフィールドを持つPRODUCTSテーブルを自動的に作成するものとする

### 要件 2

**ユーザーストーリー：** 開発者として、マルチステップバッチジョブを定義し、複雑なデータ処理ワークフローを編成できるようにしたい。

#### 受け入れ基準

1. バッチ設定が読み込まれたとき、システムは「productEtlJob」という名前のジョブを定義するものとする
2. ジョブが実行されたとき、システムは「step1_loadCsvToDb」に続いて「step2_generateReportFromDb」の2つのステップを順次実行するものとする
3. step1が失敗した場合、システムはstep2を実行してはならない
4. 両方のステップが正常に完了したとき、システムはジョブを完了としてマークするものとする

### 要件 3

**ユーザーストーリー：** 開発者として、CSVから データベースに製品データをインポートし、ファイルベースの入力処理とデータベース出力を学習できるようにしたい。

#### 受け入れ基準

1. step1が開始されたとき、システムは少なくとも10の製品レコードを含むproducts.csvファイルから読み取るものとする
2. CSVデータを読み取るとき、システムは各行をid、name、description、priceフィールドを持つProduct JPAエンティティにマップするものとする
3. アイテムを処理するとき、システムはオプションでデータを変換する（importDateフィールドの追加など）ものとする
4. データを書き込むとき、システムはJpaItemWriterを使用してProductエンティティをPRODUCTSテーブルにバッチ挿入するものとする
5. step1が完了したとき、PRODUCTSテーブルはCSVファイルのすべてのデータを含むものとする

### 要件 4

**ユーザーストーリー：** 開発者として、データベースデータからフィルタリングされたレポートを生成し、データベースベースの入力処理とファイル出力を学習できるようにしたい。

#### 受け入れ基準

1. step2が開始されたとき、システムはJpaPagingItemReaderを使用してPRODUCTSテーブルからProductエンティティを読み取るものとする
2. アイテムを処理するとき、システムは価格が50より大きい製品をフィルタリングするものとする
3. フィルタリングされたアイテムを処理するとき、システムはProductエンティティをSalesReport DTOオブジェクトに変換するものとする
4. レポートデータを書き込むとき、システムはFlatFileItemWriterを使用してproductId、productName、priceの列を持つsales_report.csvを作成するものとする
5. step2が完了したとき、sales_report.csvファイルはプロジェクトルートディレクトリに存在するものとする
6. レポートファイルを調べるとき、価格が50より大きい製品のみを含むものとする

### 要件 5

**ユーザーストーリー：** 開発者として、適切なエラーハンドリングとログ記録により、バッチジョブの実行を監視およびトラブルシューティングできるようにしたい。

#### 受け入れ基準

1. いずれかのステップでエラーが発生したとき、システムは詳細なエラー情報をログに記録するものとする
2. ステップが失敗したとき、システムはジョブの実行を停止し、ジョブを失敗としてマークするものとする
3. ジョブが実行されているとき、システムは各ステップの進行状況情報を提供するものとする
4. ジョブが完了したとき、システムは読み取り、処理、書き込みされたアイテムを含む要約統計をログに記録するものとする